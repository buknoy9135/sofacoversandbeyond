<div class="bg-white py-10 sm:py-14">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2"><%= @product.name %></h1>
      <% if @product.price.present? %>
        <p class="text-xl sm:text-2xl font-semibold text-emerald-600 mb-4"><%= number_to_currency(@product.price, unit: "₱", precision: 2) %></p>
      <% else %>
        <p class="text-gray-400 italic mb-4">Price available on request</p>
      <% end %>
      <% @product.description.split("\n\n").each do |paragraph| %>
        <p class="text-base sm:text-lg text-gray-600 leading-relaxed"><%= paragraph %></p>
      <% end %>
    </div>

    <!-- Photos -->
    <div class="mb-10">
      <h3 class="text-lg font-medium text-gray-800 mb-3">Photos</h3>
      <% if @product.images.attached? %>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          <% @product.images.each_with_index do |photo, index| %>
            <div class="w-full h-44 bg-black rounded-lg overflow-hidden border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer">
              <%= image_tag photo, class: "w-full h-full object-contain", loading: "lazy", data: { index: index, images: @product.images.map { |p| url_for(p) }.to_json } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-400 italic">No photos uploaded yet.</p>
      <% end %>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
      <button onclick="closeLightbox()" class="absolute top-4 right-6 text-white text-3xl">&times;</button>
      <button onclick="prevImage()" class="absolute left-4 text-white text-4xl">&#10094;</button>
      <img id="lightboxImage" class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg" />
      <button onclick="nextImage()" class="absolute right-4 text-white text-4xl">&#10095;</button>
    </div>

    <!-- YouTube Video -->
    <% if @product.youtube_url.present? %>
      <div class="mb-10">
        <h3 class="text-lg font-medium text-gray-800 mb-3">Video</h3>
        <% video_id = @product.youtube_url.split("v=").last %>
        <div class="relative w-full aspect-[16/9] rounded-lg overflow-hidden shadow-sm">
          <iframe class="w-full h-full" src="https://www.youtube.com/embed/<%= video_id %>" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center mt-8">
      <%= link_to "← Back", products_path, class: "w-full sm:w-auto px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-center" %>
      <%= link_to "Request Quote", new_quote_request_path(product_id: @product.id), class: "w-full sm:w-auto px-5 py-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition text-center" %>

      <% if admin_signed_in? %>
        <%= link_to "Edit", edit_product_path(@product), class: "w-full sm:w-auto px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-center" %>
        <%= button_to "Delete", product_path(@product), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this product?" }, class: "w-full sm:w-auto px-5 py-2.5 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition text-center" %>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const thumbnails = document.querySelectorAll("[data-images]");
  const lightbox = document.getElementById("lightbox");
  const lightboxImage = document.getElementById("lightboxImage");
  let currentIndex = 0;
  let images = [];

  thumbnails.forEach((thumb) => {
    thumb.loading = "lazy"; // enable lazy-loading
    thumb.addEventListener("click", () => {
      images = JSON.parse(thumb.dataset.images);
      currentIndex = parseInt(thumb.dataset.index);
      openLightbox();
    });
  });

  function openLightbox() {
    lightboxImage.src = images[currentIndex];
    lightbox.classList.remove("hidden");
  }

  window.closeLightbox = function () {
    lightbox.classList.add("hidden");
    lightboxImage.src = "";
  };

  window.prevImage = function () {
    if (images.length === 0) return;
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    lightboxImage.src = images[currentIndex];
  };

  window.nextImage = function () {
    if (images.length === 0) return;
    currentIndex = (currentIndex + 1) % images.length;
    lightboxImage.src = images[currentIndex];
  };

  // Close lightbox with ESC key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowLeft") prevImage();
    if (e.key === "ArrowRight") nextImage();
  });
});
</script>
